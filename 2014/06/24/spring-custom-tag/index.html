<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Language" contect="zh-CN">
  <meta name="DEscription" contect="潘俊俊 ITCamel itcamel 技术博客 java">
  <meta name="msvalidate.01" content="E9ABDA0017F73425E87A682DB620B6B6" />
  
  <title>Spring自定义标签 | ITCamel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta content="article" property="og:type">
<meta content="Spring自定义标签" property="og:title">
<meta content="www.itcamel.com/2014/06/24/spring-custom-tag/" property="og:url">
<meta content="http://itcamel.qiniudn.com/a2d7e37b-e394-3f90-bf20-7f480db1dc5d.jpg" property="og:image">
<meta content="ITCamel" property="og:site_name">
<meta content="前言
最近在看到一些开源框架的代码，诸如Spring、Dubbo、Webx3,在其中都有很多自定义的标签。这些标签见形知意，一下就显得高达上了。所以作为程序员，非常有必要掌握这个装X利器。介绍本文之前是基于大家了解XML的DTD和XSD的基础上。如果对这两块内容不熟悉的同学，请先行回炉下。本文主要介绍如何基于Spring进行自定义标签的扩展，以及这块功能的实现原理。" property="og:description">
<meta content="summary" name="twitter:card">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!--  -->
  
 
 <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
 
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ITCamel</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">关注IT浪潮，却在沙滩边拾捡贝壳的骆驼</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:www.itcamel.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-spring-custom-tag" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/06/24/spring-custom-tag/" class="article-date">
  <time datetime="2014-06-24T12:28:04.000Z" itemprop="datePublished">6月 24 2014</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/开源框架/">开源框架</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Spring自定义标签
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言">前言</h3>
<p>最近在看到一些开源框架的代码，诸如Spring、Dubbo、Webx3,在其中都有很多自定义的标签。这些标签见形知意，一下就显得高达上了。所以作为程序员，非常有必要掌握这个装X利器。介绍本文之前是基于大家了解XML的DTD和XSD的基础上。如果对这两块内容不熟悉的同学，请先行回炉下。<br>本文主要介绍如何基于Spring进行自定义标签的扩展，以及这块功能的实现原理。<br><a id="more"></a></p>
<h3 id="Spring配置文件">Spring配置文件</h3>
<p>spring 1.x的配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN"
    "http://www.springframework.org/dtd/spring-beans.dtd"&gt;
&lt;beans&gt;
    &lt;bean id="transactionManager"
        class="com.apress.prospring2.namespaces.NoopPlatformTransactionManager"/&gt;
    &lt;bean id="greetingsList"
        class="org.springframework.beans.factory.config.ListFactoryBean"&gt;
        &lt;property name="sourceList"&gt;
            &lt;list&gt;
                &lt;value&gt;Hello, World&lt;/value&gt;
                &lt;value&gt;What do you want to do tomorrow?&lt;/value&gt;
                &lt;value&gt;Nazdar, prdi&lt;/value&gt;
            &lt;/list&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
    &lt;bean id="greeterService"
        class="org.springframework.transaction.interceptor.
            TransactionProxyFactoryBean"&gt;
        &lt;property name="transactionManager" ref="transactionManager"/&gt;
        &lt;property name="target"&gt;
            &lt;bean class="com.apress.prospring2.namespaces.ComplexGreeterService"&gt;
                &lt;property name="greetings" ref="greetingsList"/&gt;
            &lt;/bean&gt;
        &lt;/property&gt;
        &lt;property name="transactionAttributes"&gt;
            &lt;props&gt;
                &lt;prop key="greet*"&gt;PROPAGATION_REQUIRED&lt;/prop&gt;
            &lt;/props&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</pre></td></tr></table></figure>

<p>spring 2.x的配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLschema-instance" xmlns:util="http://www.springframework.org/schema/util"
    xmlns:tx="http://www.springframework.org/schema/tx" xmlns:aop="http://www.springframework.org/schema/aop"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
        http://www.springframework.org/schema/util
        http://www.springframework.org/schema/util/spring-util-2.5.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx-2.5.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop-2.5.xsd"&gt;
    &lt;bean id="transactionManager"
        class="com.apress.prospring2.namespaces.NoopPlatformTransactionManager" /&gt;
    &lt;util:list id="greetingsList"&gt;
        &lt;value&gt;Hello, world&lt;/value&gt;
        &lt;value&gt;What do you want to do tomorrow?&lt;/value&gt;
        &lt;value&gt;Nazdar, prdi&lt;/value&gt;
    &lt;/util:list&gt;
    &lt;bean id="greeterService" class="com.apress.prospring2.namespaces.ComplexGreeterService"&gt;
        &lt;property name="greetings" ref="greetingsList" /&gt;
    &lt;/bean&gt;
    &lt;tx:advice id="greeterServiceAdvice" transaction-manager="transactionManager"&gt;
        &lt;tx:attributes&gt;
            &lt;tx:method name="greet*" propagation="REQUIRED" /&gt;
        &lt;/tx:attributes&gt;
    &lt;/tx:advice&gt;
    &lt;aop:config&gt;
        &lt;aop:pointcut id="greeterServiceOperation"
            expression="execution(* com.apress.*.*.GreeterService.*(..))" /&gt;
        &lt;aop:advisor advice-ref="greeterServiceAdvice"
            pointcut-ref="greeterServiceOperation" /&gt;
    &lt;/aop:config&gt;
&lt;/beans&gt;
</pre></td></tr></table></figure>

<p>两个配置文件达到的效果是一样的。但是2.x版本的更加简洁和清晰。但是为什么<util/>、<tx/>等标签，Spring框架能够很好的进行解析呢？ 这个归功于spring框架对schema的支持。</p>
<h4 id="Schemas_Included_in_Spring_2-5">Schemas Included in Spring 2.5</h4>
<table>
<thead>
<tr>
<th>Schema</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td>util</td>
<td>Utility functions for declaration of constants,lists,maps,properties,and property paths.</td>
<td></td>
</tr>
<tr>
<td>j2ee</td>
<td>J2EE functions for working with the JNDI and EJBs.</td>
<td></td>
</tr>
<tr>
<td>jms</td>
<td>Adds support for simple configuration of JMS beans.</td>
<td></td>
</tr>
<tr>
<td>lang</td>
<td>Allows objects exposed by languages such as JRuby to be used as Spring beans.</td>
<td></td>
</tr>
<tr>
<td>tx</td>
<td>Allows you to declare transactional properties of your Spring beans</td>
<td></td>
</tr>
<tr>
<td>aop</td>
<td>Deals with aspect-oriended programming elements,such as pointcuts and advice</td>
<td></td>
</tr>
<tr>
<td>tool</td>
<td>This schema is intended to be used by developers of additional components;the developers use the tool schema to add metadata that the third-party components use</td>
<td></td>
</tr>
<tr>
<td>context</td>
<td>Allows you to control the wiring up process and bean post-processing</td>
<td></td>
</tr>
<tr>
<td>beans</td>
<td>Use this schema to declare beans,aliases,and imports;this is usually the default schema in the XML file.</td>
<td></td>
</tr>
</tbody>
</table>
<p>以context为例</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="tag">&lt;<span class="title">beans</span> <span class="attribute">xmlns</span>=<span class="value">"http://www.springframework.org/schema/beans"</span>
    <span class="attribute">xmlns:xsi</span>=<span class="value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="attribute">xmlns:context</span>=<span class="value">"http://www.springframework.org/schema/context"</span>
    <span class="attribute">xsi:schemaLocation</span>=<span class="value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-2.5.xsd"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">context:property-placeholder</span> <span class="attribute">location</span>=
        "<span class="attribute">classpath:</span>/<span class="attribute">com</span>/<span class="attribute">apress</span>/<span class="attribute">prospring2</span>/<span class="attribute">ch07</span>/<span class="attribute">context</span>/<span class="attribute">test.properties</span>" /&gt;</span>
<span class="tag">&lt;/<span class="title">beans</span>&gt;</span>
</pre></td></tr></table></figure>

<p>上面context是命名空间”<a href="http://www.springframework.org/schema/context&quot;的别名，带有这个别名的标签都是通过这个命名空间对应的DTD或者XSD定义结构体的。而在标签名称前缺少别名的默认用的是命名空间&quot;http://www.springframework.org/schema/beans&quot;。" target="_blank">http://www.springframework.org/schema/context&quot;的别名，带有这个别名的标签都是通过这个命名空间对应的DTD或者XSD定义结构体的。而在标签名称前缺少别名的默认用的是命名空间&quot;http://www.springframework.org/schema/beans&quot;。</a></p>
<h4 id="Spring对命名空间内元素的解析">Spring对命名空间内元素的解析</h4>
<p>在Spring包的META-INF目录下有两个文件：spring.handlers和spring.schemas</p>
<p>spring.handlers</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/aop=org<span class="preprocessor">.springframework</span><span class="preprocessor">.aop</span><span class="preprocessor">.config</span><span class="preprocessor">.AopNamespaceHandler</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/context=org<span class="preprocessor">.springframework</span><span class="preprocessor">.context</span><span class="preprocessor">.config</span><span class="preprocessor">.ContextNamespaceHandler</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/jee=org<span class="preprocessor">.springframework</span><span class="preprocessor">.ejb</span><span class="preprocessor">.config</span><span class="preprocessor">.JeeNamespaceHandler</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/jms=org<span class="preprocessor">.springframework</span><span class="preprocessor">.jms</span><span class="preprocessor">.config</span><span class="preprocessor">.JmsNamespaceHandler</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/lang=org<span class="preprocessor">.springframework</span><span class="preprocessor">.scripting</span><span class="preprocessor">.config</span><span class="preprocessor">.LangNamespaceHandler</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/p=org<span class="preprocessor">.springframework</span><span class="preprocessor">.beans</span><span class="preprocessor">.factory</span><span class="preprocessor">.xml</span><span class="preprocessor">.SimplePropertyNamespaceHandler</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/tx=org<span class="preprocessor">.springframework</span><span class="preprocessor">.transaction</span><span class="preprocessor">.config</span><span class="preprocessor">.TxNamespaceHandler</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/util=org<span class="preprocessor">.springframework</span><span class="preprocessor">.beans</span><span class="preprocessor">.factory</span><span class="preprocessor">.xml</span><span class="preprocessor">.UtilNamespaceHandler</span>
</pre></td></tr></table></figure>

<p>这里指定了使用了命名空间<a href="http://www.springframework.org/schema/aop的标签由org.springframework.aop.config.AopNamespaceHandler负责解析。" target="_blank">http://www.springframework.org/schema/aop的标签由org.springframework.aop.config.AopNamespaceHandler负责解析。</a></p>
<p>spring.schemas</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/aop/spring-aop-<span class="number">2.0</span><span class="preprocessor">.xsd</span>=org/springframework/aop/config/spring-aop-<span class="number">2.0</span><span class="preprocessor">.xsd</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/aop/spring-aop-<span class="number">2.5</span><span class="preprocessor">.xsd</span>=org/springframework/aop/config/spring-aop-<span class="number">2.5</span><span class="preprocessor">.xsd</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/aop/spring-aop<span class="preprocessor">.xsd</span>=org/springframework/aop/config/spring-aop-<span class="number">2.5</span><span class="preprocessor">.xsd</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/beans/spring-beans-<span class="number">2.0</span><span class="preprocessor">.xsd</span>=org/springframework/beans/factory/xml/spring-beans-<span class="number">2.0</span><span class="preprocessor">.xsd</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/beans/spring-beans-<span class="number">2.5</span><span class="preprocessor">.xsd</span>=org/springframework/beans/factory/xml/spring-beans-<span class="number">2.5</span><span class="preprocessor">.xsd</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/beans/spring-beans<span class="preprocessor">.xsd</span>=org/springframework/beans/factory/xml/spring-beans-<span class="number">2.5</span><span class="preprocessor">.xsd</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/context/spring-context-<span class="number">2.5</span><span class="preprocessor">.xsd</span>=org/springframework/context/config/spring-context-<span class="number">2.5</span><span class="preprocessor">.xsd</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/context/spring-context<span class="preprocessor">.xsd</span>=org/springframework/context/config/spring-context-<span class="number">2.5</span><span class="preprocessor">.xsd</span>
http\://www<span class="preprocessor">.springframework</span><span class="preprocessor">.org</span>/schema/jee/spring-jee-<span class="number">2.0</span><span class="preprocessor">.xsd</span>=org/springframework/ejb/config/spring-jee-<span class="number">2.0</span><span class="preprocessor">.xsd</span>
</pre></td></tr></table></figure>

<p>这里指定了命名空间http\://www.springframework.org/schema/aop/spring-aop-2.0.xsd本地的映射文件是org/springframework/aop/config/spring-aop-2.0.xsd</p>
<h3 id="解析原理">解析原理</h3>
<p>XML标签到Spring bean的解析过程：<br><img src="http://itcamel.qiniudn.com/a2d7e37b-e394-3f90-bf20-7f480db1dc5d.jpg" alt="标签解析"></p>
<p>解析过程中的类交互图：<br><img src="http://itcamel.qiniudn.com/origin_image011.png" alt="类交互图"></p>
<p>XmlBeanDefinitionReader是核心类，它接收 spring 容器传给它的资源 resource 文件，由它负责完成整个转换。它调用 DefaultDocumentLoader来完成将Resource 到Dom树的转换。调用DefaultBeanDefinitionDocumentReader完成将Dom树到BeanDefinition的转换。</p>
<p><strong>Step1：把xml解析成Dom树。将 xml 文件解析成 dom 树，需要对应 schema 来验证文件结构。spring容器启动扫描classpath 的META-INF/spring.schemas文件。从文件读取本地的xsd。</strong><br>xml配置文件的读取由XMLBeanDefinationReader发起，并由XMLBeanDefinationReader接受配置文件。加载首先由ResourceLoader开始，把配置文件加载为Resource对象，接着转化成InputStream形式，InputStream转成inputSource，并在doLoadBeanDefinitions(InputSource inputSource, Resource resource)方法中，完成Document形式资源的转化。<br>转化在ResourceEntityResolver中实现。ResourceEntityResolver里面有两个工具类：PluggableSchemaResolver对xsd类型的文件进行解析，BeansDTDResolver对DTD类型的文件进行解析。Spring同时支持两种xml结构格式定义。而最终转换Document的工作是由DocumentLoader来完成。</p>
<p><strong>Step2：bean转化成BeanDifinition</strong><br>如果是<bean>标签，spring会自动解析。如果是自定义的标签如<aop>、<util>则需要专门指定xmlparser. parser在spring.handlers文件中定义。定义包括具体的命名空间及对应的Handler映射。spring容器启动后加载 handler，handler会向容器注册该命名空间下的标签和解析器。在解析的自定义标签的时候，spring 会根据标签的命名空间和标签名找到一个解析器。由该解析器来完成对该标签内容的解析，并最终返回BeanDefinition。</p>
<p>表面上看是DefaultBeanDefinitionDocumentReader完成了Dom到BeanDefinition转换，实际上是委托了给BeanDefinitionParserDelegate。<br>DefaultBeanDefinitionDocumentReader</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span>(Document doc, XmlReaderContext readerContext) {
        <span class="keyword">this</span>.readerContext = readerContext;
 
        logger.debug(<span class="string">"Loading bean definitions"</span>);
        Element root = doc.getDocumentElement();
 
        BeanDefinitionParserDelegate <span class="keyword">delegate</span> = createHelper(readerContext, root);
 
        preProcessXml(root);
        parseBeanDefinitions(root, <span class="keyword">delegate</span>);
        postProcessXml(root);
    }
</pre></td></tr></table></figure>

<p>preProcessXml(root)，postProcessXml(root)都是空实现，是准备给我们扩展用的。有效的实现在parseBeanDefinitions(root, delegate)中。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre>protected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) {
	if (delegate.isDefaultNamespace(root.getNamespaceURI())) {
		NodeList nl = root.getChildNodes();
		for (int i = 0; i &lt; nl.getLength(); i++) {
			Node node = nl.item(i);
			if (node instanceof Element) {
				Element ele = (Element) node;
				String namespaceUri = ele.getNamespaceURI();
				if (delegate.isDefaultNamespace(namespaceUri)) {
					parseDefaultElement(ele, delegate);
				}
				else {
					delegate.parseCustomElement(ele);
				}
			}
		}
	}
	else {
		delegate.parseCustomElement(root);
	}
}
</pre></td></tr></table></figure>

<p>如我们刚才介绍，根据命名空间判断，如果是默认的bean标签，则直接解析parseDefaultElement;如果是自定义的标签，则delegate.parseCustomElement(ele)。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span>(Element ele, BeanDefinition containingBd) {
	String namespaceUri = ele.getNamespaceURI();
	NamespaceHandler handler = <span class="keyword">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);
	<span class="keyword">if</span> (handler == <span class="keyword">null</span>) {
		error(<span class="string">"Unable to locate Spring NamespaceHandler for XML schema namespace ["</span> + namespaceUri + <span class="string">"]"</span>, ele);
		<span class="keyword">return</span> <span class="keyword">null</span>;
	}
	<span class="keyword">return</span> handler.parse(ele, <span class="keyword">new</span> ParserContext(<span class="keyword">this</span>.readerContext, <span class="keyword">this</span>, containingBd));
}
</pre></td></tr></table></figure>

<p>XmlReaderContext这个类最关键的属性是NamespaceHandlerResolver，NamespaceHandlerResolver能够根据Element的namespaceUri返回对应的NamespaceHandler(见spring.handlers文件中配置)。</p>
<h4 id="NamespaceHandler和NamespaceHandlerSupport">NamespaceHandler和NamespaceHandlerSupport</h4>
<p>NamespaceHandler</p>
<ul>
<li>Base interface used by the {@link DefaultBeanDefinitionDocumentReader}</li>
<li><p>for handling custom namespaces in a Spring XML configuration file.</p>
</li>
<li><p><p>Implementations are expected to return implementations of the</p>
</li>
<li>{@link BeanDefinitionParser} interface for custom top-level tags and</li>
<li>implementations of the {@link BeanDefinitionDecorator} interface for</li>
<li><p>custom nested tags.</p>
</li>
<li><p><p>The parser will call {@link #parse} when it encounters a custom tag</p>
</li>
<li>directly under the <code>&lt;beans&gt;</code> tags and {@link #decorate} when</li>
<li><p>it encounters a custom tag directly under a <code>&lt;bean&gt;</code> tag.</p>
</li>
<li><p><p>Developers writing their own custom element extensions typically will</p>
</li>
<li>not implement this interface drectly, but rather make use of the provided</li>
<li>{@link NamespaceHandlerSupport} class.</li>
</ul>
<p>NamespaceHandlerSupport</p>
<ul>
<li>Support class for implementing custom {@link NamespaceHandler NamespaceHandlers}. Parsing and</li>
<li>decorating of individual {@link Node Nodes} is done via {@link BeanDefinitionParser} and</li>
<li>{@link BeanDefinitionDecorator} strategy interfaces respectively. Provides the</li>
<li>{@link #registerBeanDefinitionParser}, {@link #registerBeanDefinitionDecorator} methods</li>
<li>for registering a {@link BeanDefinitionParser} or {@link BeanDefinitionDecorator} to handle</li>
<li>a specific element.<br>从定义上看出，NamespaceHandlerSupport是一个为更好实现自定义标签功能而基于NamespaceHandler的一个抽象实现类。以UtilNamespaceHandler为例：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UtilNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> {</span>

	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCOPE_ATTRIBUTE = <span class="string">"scope"</span>;


	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span>() {
		registerBeanDefinitionParser(<span class="string">"constant"</span>, <span class="keyword">new</span> ConstantBeanDefinitionParser());
		registerBeanDefinitionParser(<span class="string">"property-path"</span>, <span class="keyword">new</span> PropertyPathBeanDefinitionParser());
		registerBeanDefinitionParser(<span class="string">"list"</span>, <span class="keyword">new</span> ListBeanDefinitionParser());
		registerBeanDefinitionParser(<span class="string">"set"</span>, <span class="keyword">new</span> SetBeanDefinitionParser());
		registerBeanDefinitionParser(<span class="string">"map"</span>, <span class="keyword">new</span> MapBeanDefinitionParser());
		registerBeanDefinitionParser(<span class="string">"properties"</span>, <span class="keyword">new</span> PropertiesBeanDefinitionParser());
	}


	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantBeanDefinitionParser</span> <span class="keyword">extends</span> <span class="title">AbstractSimpleBeanDefinitionParser</span> {</span>

		<span class="keyword">protected</span> Class <span class="title">getBeanClass</span>(Element element) {
			<span class="keyword">return</span> FieldRetrievingFactoryBean.class;
		}

		<span class="keyword">protected</span> String <span class="title">resolveId</span>(Element element, AbstractBeanDefinition definition, ParserContext parserContext) {
			String id = <span class="keyword">super</span>.resolveId(element, definition, parserContext);
			<span class="keyword">if</span> (!StringUtils.hasText(id)) {
				id = element.getAttribute(<span class="string">"static-field"</span>);
			}
			<span class="keyword">return</span> id;
		}
	}.....
</pre></td></tr></table></figure>

<p>constant、set、map、properties等不同的Dom结点都有不同的BeanDefinitionParser负责解析。<br>可以看到具体的有两个方法getBeanClass(Element element)和resolveId(Element element, AbstractBeanDefinition definition, ParserContext parserContext)。一个完成Element到Bean的Class的映射，一个获取bean实例的Id。任何的bean实例在spring容器中都有一个唯一的id。</p>
<p>BeanDefinitionParser的管理由NamespaceHandlerSupport负责。通过registerBeanDefinitionParser方法注册映射关系。具体转换Element使用不同的BeanDefinitionParser</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre><span class="keyword">public</span> <span class="keyword">final</span> BeanDefinition <span class="title">parse</span>(Element element, ParserContext parserContext) {
		<span class="keyword">return</span> findParserForElement(element, parserContext).parse(element, parserContext);
	}
</pre></td></tr></table></figure>

<p><strong>Step3：注册就完成了。剩下要做的工作就交给了BeanFacroty来进行各种初始。</strong></p>
<h4 id="重要接口和派生类">重要接口和派生类</h4>
<ol>
<li><p>NamespaceHandler及其abstract实现类NamespaceHandlerSupport。要解析自定义的bean就要通过自己所实现的NamespaceHandler来进行解析。比如定义了 http\://www.springframework.org/schema /osgi=org.springframework.osgi.config.OsgiNamespaceHandler,那么在碰到osgi的 scheme的时候就会去调用OsgiNamespaceHandler来进行解析；在对于普通的扩展需求来说，只要让自己的Handler继承NamespaceHandlerSupport并实现init()方法 就好了，对于特殊的扩展需求 则可以自己来实现NamespaceHandler。</p>
</li>
<li><p>BeanDefinitionParser及其abstract实现类AbstractBeanDefinitionParser，AbstractSingleBeanDefinitionParser。BeanDefinitionParser中唯一要我们实现的方法 就是parse(Element element, ParserContext parserContext);当然直接实现这个接口自己要扩展的就要很多了。最简单地方法就是扩展BeanDefinitionParser的两个派生类。<br><strong>继承AbstractBeanDefinitionParser</strong><br>继承这个类主要需要实现的是抽象方法protected abstract AbstractBeanDefinition parseInternal(Element element, ParserContext parserContext);其他方法可以根据需要进行扩展。<br><strong>继承AbstractSingleBeanDefinitionParser</strong><br>继承这个类主要需要实现抽象方法protected void doParse(Element element, BeanDefinitionBuilder builder) ，protected Class getBeanClass(Element element)，protected String getBeanClassName(Element element)等,我们需要关注的方法是doParse，由于AbstractSingleBeanDefinitionParser继承了 AbstractBeanDefinitionParser，前者是在parse了单条beanDefination的基础上允许扩展着对xml文件中的 其他内容进行解析并扩展到前面的beanDefination中，最后返回一条beanDefination。而 AbstractBeanDefinitionParser所扩展的parseInternal方法可以虽然可以实现和 AbstractSingleBeanDefinitionParser相同的作用，但其目的只是提供更加基本的一个扩展。可以实现简单或者复杂的应用场景。<br>BeanDefinitionParser的派生子类还有很多，进一步的其他应用，还需要深入按照场景进行研究。</p>
</li>
<li><p>BeanDefinitionBuilder和ParserUtils<br>BeanDefinitionBuilder提供了简单全面的beanDefination的生成方法，以及beanDefination的各种属性的操作方法。<br>ParserUtils提供了parseCustomAttributes以及AttributeCallback回调接口用来设置相关的beanDefination内容。</p>
</li>
</ol>
<h4 id="标签解析中3种可扩展的方式">标签解析中3种可扩展的方式</h4>
<ol>
<li>DefaultBeanDefinitionDocumentReader的registerBeanDefinitions方法包括三个步骤：<br>1、preProcessXml(root)<br>2、parseBeanDefinitions(root, delegate)<br>3、postProcessXml(root) 。<br>1和3两个步骤方法是缺省实现的，可覆盖，可对Document节点进行简单操作。</li>
<li>XmlBeanDefinitionReader中可以把自己定义的DocumentLoader、ProblemReporter、EventListener，ErrorHandler设置进来。</li>
<li>自定义标签和解析hanlder<br>DefaultBeanDefinitionDocumentReader的parseBeanDefinitions方法执行过程中，会发现标签的scheme不是默认的Namespace（beans标签引用的是默认Namespace），就会根据上下文取自定义的namespaceHandlerResolver解析NamespaceUri，并返回对应的NamespaceHandler，由NamespaceHandler解析返回BeanDefination。<br>通过BeanDefinitionParserDelegate的parseCustomElement（）方法。<br>第1和第2中是比较简便和快捷的方式，基于原有的标签就可以做一些扩展。而第3中方式是自定义自己的标签。<br>自定义标签的几个步骤：</li>
</ol>
<ul>
<li>设计配置属性和JavaBean</li>
<li>编写XSD文件</li>
<li>编写NamespaceHandler和BeanDefinitionParser完成解析工作</li>
<li>编写spring.handlers和spring.schemas串联起所有部件</li>
<li>在Bean文件中应用</li>
</ul>

      
    </div>
    <footer class="article-footer">
 

      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/">spring</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2014/06/23/dependency-conflict/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">jar依赖冲突解决实践</div>
    </a>
  
</nav>

  
</article>




         <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_xg" data-cmd="xg" title="分享到鲜果"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{},"image":{"viewList":["tsina","douban","tqq","weixin","xg"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","douban","tqq","weixin","xg"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>



    <!-- 多说评论框 start -->
 <h1 class="title">comment</h1>
 <div class="ds-thread" data-title="Spring自定义标签"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"huoyanxueren"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->



</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux系统知识/">Linux系统知识</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/交流分享/">交流分享</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/开源框架/">开源框架</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统运维/">系统运维</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chuwa/">Chuwa</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DMA/">DMA</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flume/">Flume</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MMU/">MMU</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SVN/">SVN</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SVNKit/">SVNKit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scribe/">Scribe</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zero-copy/">Zero-copy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dependency/">dependency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/infoq/">infoq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jps/">jps</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jstat/">jstat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/">kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nio/">nio</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qcon/">qcon</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/会议/">会议</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/北京/">北京</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/性能优化/">性能优化</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/性能，优化，服务器，负载/">性能，优化，服务器，负载</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/日志/">日志</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/杂谈/">杂谈</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/虚拟机/">虚拟机</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Chuwa/" style="font-size: 10.00px;">Chuwa</a><a href="/tags/DMA/" style="font-size: 10.00px;">DMA</a><a href="/tags/Flume/" style="font-size: 10.00px;">Flume</a><a href="/tags/JVM/" style="font-size: 20.00px;">JVM</a><a href="/tags/MMU/" style="font-size: 10.00px;">MMU</a><a href="/tags/SVN/" style="font-size: 10.00px;">SVN</a><a href="/tags/SVNKit/" style="font-size: 10.00px;">SVNKit</a><a href="/tags/Scribe/" style="font-size: 10.00px;">Scribe</a><a href="/tags/Zero-copy/" style="font-size: 10.00px;">Zero-copy</a><a href="/tags/dependency/" style="font-size: 10.00px;">dependency</a><a href="/tags/infoq/" style="font-size: 10.00px;">infoq</a><a href="/tags/jps/" style="font-size: 10.00px;">jps</a><a href="/tags/jstat/" style="font-size: 10.00px;">jstat</a><a href="/tags/kafka/" style="font-size: 10.00px;">kafka</a><a href="/tags/linux/" style="font-size: 10.00px;">linux</a><a href="/tags/maven/" style="font-size: 10.00px;">maven</a><a href="/tags/nio/" style="font-size: 10.00px;">nio</a><a href="/tags/qcon/" style="font-size: 10.00px;">qcon</a><a href="/tags/spring/" style="font-size: 10.00px;">spring</a><a href="/tags/会议/" style="font-size: 10.00px;">会议</a><a href="/tags/北京/" style="font-size: 10.00px;">北京</a><a href="/tags/性能优化/" style="font-size: 15.00px;">性能优化</a><a href="/tags/性能，优化，服务器，负载/" style="font-size: 10.00px;">性能，优化，服务器，负载</a><a href="/tags/日志/" style="font-size: 10.00px;">日志</a><a href="/tags/杂谈/" style="font-size: 10.00px;">杂谈</a><a href="/tags/虚拟机/" style="font-size: 15.00px;">虚拟机</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06">六月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04">四月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02">二月 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11">十一月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/09">九月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08">八月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/03">三月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10">十月 2011</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2014/06/24/spring-custom-tag/">Spring自定义标签</a>
          </li>
        
          <li>
            <a href="/2014/06/23/dependency-conflict/">jar依赖冲突解决实践</a>
          </li>
        
          <li>
            <a href="/2014/04/25/qcon-1st/">北京Qcon走马观花</a>
          </li>
        
          <li>
            <a href="/2013/02/26/nio-grammer/">NIO学习全概括</a>
          </li>
        
          <li>
            <a href="/2013/02/19/zero-copy/">zero-copy</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
<h3 class="widget-title">友情链接</h3>
<ul class="entry widget">
<li><a href="http://gkbusy.iteye.com/" title="gkbusy's Blog">gkbusy的博客</a></li>
<li><a href="http://javatar.iteye.com/" title="梁飞的博客">梁飞的博客</a></li>
<li><a href="http://agapple.iteye.com/" title="agapple's Blog">agapple的博客</a></li>
<li><a href="http://www.alidata.org/" title="阿里数据平台">阿里数据平台</a></li>
<li><a href="http://www.yangbolin.github.io/myblog/" title="yangbolin">yangbolin的blog</a></li>
</ul>
</div>

  
    <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=1946907151&verifier=c39dc63c&dpc=1"></iframe>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2014 潘俊俊<br>
      阿里巴巴资深开发工程师、Java、大数据、语言<br>
      E-mail:1983@live.cn<br>
      Powered by <a href="http://itcamel.com" target="_blank">潘俊俊</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    <script src="/fancybox/jquery-1.7.2.min.js"></script>


<!-- <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"> -->
<!-- <script src="/fancybox/jquery.fancybox.pack.js"></script> -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Ff3d905ba4b2eaa8c625d50b00801cb47' type='text/javascript'%3E%3C/script%3E"));
</script>



<script type="text/javascript" src="/js/script.js"></script>

  </div>
</body>
</html>
